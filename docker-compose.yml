
services:
  # ─────────────────────────────────────────
  # API Gateway (FastAPI)
  # ─────────────────────────────────────────
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: ai-api
    restart: unless-stopped
    ports:
      - "8100:8000"
    environment:
      APP_ENV: production
      APP_DEBUG: "false"
      APP_SECRET_KEY: ${APP_SECRET_KEY}
      DATABASE_URL: postgresql+asyncpg://ai_user:${DB_PASSWORD}@ai-postgres:5432/ai_aggregator
      REDIS_URL: redis://:${REDIS_PASSWORD}@ai-redis:6379/0
      S3_ENDPOINT: http://ai-minio:9000
      S3_BUCKET: ai-aggregator
      S3_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      S3_SECRET_KEY: ${MINIO_SECRET_KEY}
      S3_PUBLIC_ENDPOINT: ${S3_PUBLIC_ENDPOINT}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY}
      KIE_API_KEY: ${KIE_API_KEY}
      GOOGLE_APPLICATION_CREDENTIALS: /app/google-credentials.json
    volumes:
      - ./backend/google-credentials.json:/app/google-credentials.json:ro
    depends_on:
      ai-postgres:
        condition: service_healthy
      ai-redis:
        condition: service_healthy
    networks:
      - ai-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ─────────────────────────────────────────
  # Background Workers (Dramatiq)
  # ─────────────────────────────────────────
  worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: ai-worker
    restart: unless-stopped
    command: python -m dramatiq app.workers --processes 2 --threads 4
    environment:
      APP_ENV: production
      DATABASE_URL: postgresql+asyncpg://ai_user:${DB_PASSWORD}@ai-postgres:5432/ai_aggregator
      REDIS_URL: redis://:${REDIS_PASSWORD}@ai-redis:6379/0
      S3_ENDPOINT: http://ai-minio:9000
      S3_BUCKET: ai-aggregator
      S3_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      S3_SECRET_KEY: ${MINIO_SECRET_KEY}
      S3_PUBLIC_ENDPOINT: ${S3_PUBLIC_ENDPOINT}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY}
      KIE_API_KEY: ${KIE_API_KEY}
      GOOGLE_APPLICATION_CREDENTIALS: /app/google-credentials.json
    volumes:
      - ./backend/google-credentials.json:/app/google-credentials.json:ro
    depends_on:
      - api
    networks:
      - ai-network

  # ─────────────────────────────────────────
  # PostgreSQL 15
  # ─────────────────────────────────────────
  ai-postgres:
    image: postgres:15-alpine
    container_name: ai-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ai_user
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ai_aggregator
    volumes:
      - ai_postgres_data:/var/lib/postgresql/data
    networks:
      - ai-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ai_user -d ai_aggregator"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ─────────────────────────────────────────
  # Redis 7 (Cache + Broker)
  # ─────────────────────────────────────────
  ai-redis:
    image: redis:7-alpine
    container_name: ai-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes
    volumes:
      - ai_redis_data:/data
    networks:
      - ai-network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ─────────────────────────────────────────
  # MinIO (S3-compatible Storage)
  # ─────────────────────────────────────────
  ai-minio:
    image: minio/minio:latest
    container_name: ai-minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY}
      MINIO_SERVER_URL: http://95.140.153.151:9200
    volumes:
      - ai_minio_data:/data
    ports:
      - "9200:9000"
      - "9201:9001"
    networks:
      - ai-network

  # ─────────────────────────────────────────
  # Admin Panel (React + Vite)
  # ─────────────────────────────────────────
  frontend:
    build:
      context: ./admin
      dockerfile: Dockerfile
    container_name: ai-frontend
    restart: unless-stopped
    ports:
      - "3000:80"
    depends_on:
      - api
    networks:
      - ai-network

networks:
  ai-network:
    name: ai-network
    driver: bridge

volumes:
  ai_postgres_data:
    name: ai_postgres_data
  ai_redis_data:
    name: ai_redis_data
  ai_minio_data:
    name: ai_minio_data